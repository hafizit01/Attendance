{% extends 'base.html' %}
{% block content %}

<div class="mx-auto max-w-7xl p-4 sm:p-6">
  <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
    <h2 class="text-2xl md:text-3xl font-bold text-gray-900">👥 Subscriptions</h2>

    <div class="flex items-center gap-2">
      <a href="?{% if q %}q={{ q }}&{% endif %}{% if status %}status={{ status }}&{% endif %}{% if start_from %}start_from={{ start_from }}&{% endif %}{% if end_to %}end_to={{ end_to }}&{% endif %}per={{ per }}&export=csv"
         class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 shadow">
        ⬇️ Export CSV
      </a>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="bg-white p-4 sm:p-6 rounded-2xl border shadow-sm mb-4">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div class="md:col-span-2">
        <label class="block text-sm text-gray-600 mb-1">🔍 Search</label>
        <input type="text" name="q" value="{{ q|default_if_none:'' }}"
               placeholder="Search by User or Plan"
               class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">📌 Status</label>
        <select name="status" class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">All</option>
          <option value="active"   {% if status == 'active' %}selected{% endif %}>Active</option>
          <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactive</option>
        </select>
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">📅 Start Date ≥</label>
        <input type="date" name="start_from" value="{{ start_from|date:'Y-m-d' }}"
               class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <div>
        <label class="block text-sm text-gray-600 mb-1">📅 End Date ≤</label>
        <input type="date" name="end_to" value="{{ end_to|date:'Y-m-d' }}"
               class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
    </div>

    <div class="mt-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-sm">
        <span>Per page</span>
        <select name="per" class="border-gray-300 rounded-lg px-2 py-1 focus:ring-blue-500 focus:border-blue-500">
          {% for n in per_choices %}
            <option value="{{ n }}" {% if per == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>
      <button class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 shadow">
        Apply Filters
      </button>
    </div>
  </form>

  <!-- Table -->
  <div class="overflow-x-auto rounded-2xl border bg-white shadow-sm">
  <table class="min-w-full text-sm text-gray-800 border-collapse">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-4 py-2 border-b text-left font-semibold">#</th>
        <th class="px-4 py-2 border-b text-left font-semibold">User</th>
        <th class="px-4 py-2 border-b text-left font-semibold">Subscription Plan</th>
        <th class="px-4 py-2 border-b text-left font-semibold">Status</th>
        <th class="px-4 py-2 border-b text-left font-semibold">Start Date</th>
        <th class="px-4 py-2 border-b text-left font-semibold">End Date</th>
      </tr>
    </thead>
    <tbody>
      {% for s in page_obj.object_list %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-2 border-b">{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td class="px-4 py-2 border-b">
            {{ s.user.get_full_name|default:s.user.username }}
            <div class="text-xs text-gray-500">@{{ s.user.username }}</div>
          </td>
          <td class="px-4 py-2 border-b">{{ s.plan.name }}</td>
          <td class="px-4 py-2 border-b">
            {% if s.active %}
              <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-2 py-0.5 text-xs">Active</span>
            {% else %}
              <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 px-2 py-0.5 text-xs">Inactive</span>
            {% endif %}
          </td>
          <td class="px-4 py-2 border-b tabular-nums">{{ s.start_date|date:"Y-m-d" }}</td>
          <td class="px-4 py-2 border-b tabular-nums">{{ s.end_date|date:"Y-m-d" }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6" class="px-4 py-6 text-center text-gray-500">No subscriptions found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


  <!-- Pagination -->
  {% if page_obj.paginator.num_pages > 1 %}
  <div class="mt-4 flex items-center justify-between text-sm">
    <div>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</div>
    <div class="flex gap-2">
      {% if page_obj.has_previous %}
        <a class="px-3 py-1 rounded border hover:bg-gray-50"
           href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status }}&start_from={{ start_from|date:'Y-m-d' }}&end_to={{ end_to|date:'Y-m-d' }}&per={{ per }}">← Prev</a>
      {% endif %}
      {% if page_obj.has_next %}
        <a class="px-3 py-1 rounded border hover:bg-gray-50"
           href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ status }}&start_from={{ start_from|date:'Y-m-d' }}&end_to={{ end_to|date:'Y-m-d' }}&per={{ per }}">Next →</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

{% endblock %}