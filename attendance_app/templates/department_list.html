{% extends "base.html" %}
{% block content %}
<div class="p-4 sm:p-6 bg-white dark:bg-gray-800 rounded shadow transition-colors duration-300">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
    <h1 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-gray-100">Departments</h1>

    <div class="flex items-center gap-2">
      <form method="get" class="flex items-center gap-2">
        <input type="text" name="q" value="{{ q|default:'' }}"
               class="w-48 sm:w-64 border dark:border-gray-700 rounded px-3 py-2 text-sm dark:bg-gray-900 dark:text-gray-100"
               placeholder="Search (name/company)">
        <button class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-3 py-2 rounded text-sm">
          Search
        </button>
        {% if q %}
        <a href="{% url 'attendance_app:department_list' %}"
           class="text-sm text-gray-600 dark:text-gray-300 underline">Clear</a>
        {% endif %}
      </form>

      {% if request.user.is_superuser %}
  <a href="{% url 'attendance_app:department_add' %}"
     class="bg-blue-600 hover:bg-blue-700 text-white px-3 sm:px-4 py-2 rounded text-sm sm:text-base transition">
    ‚ûï Add Department
  </a>
{% else %}
  <button type="button"
          class="bg-gray-400 text-white px-3 sm:px-4 py-2 rounded text-sm sm:text-base cursor-not-allowed"
          disabled>
    ‚ûï Add Department
  </button>
{% endif %}

    </div>
  </div>

  {# Django messages (optional) #}
  {% if messages %}
    <ul class="mb-3 space-y-1">
      {% for message in messages %}
        <li class="text-sm px-3 py-2 rounded
                   {% if message.tags == 'success' %} bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-200
                   {% elif message.tags == 'error' %} bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-200
                   {% else %} bg-gray-50 text-gray-700 dark:bg-gray-900/30 dark:text-gray-200 {% endif %}">
          {{ message }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  <div class="overflow-x-auto">
    <table class="table-auto w-full border border-gray-300 dark:border-gray-700 text-sm">
      <thead class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
        <tr>
          <th class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">ID</th>
          <th class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">Company</th>
          <th class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">Name</th>
          <th class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">Weekly Off Day</th>
          <th class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">Device</th>
          <th class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">Office Hours</th>
          <th class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2 text-center">Edit</th>
          <th class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2 text-center">Delete</th>
        </tr>
      </thead>
      <tbody class="text-gray-800 dark:text-gray-200">
        {% for dept in departments %}
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-900 transition">
          <td class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">{{ dept.id }}</td>

          <td class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">
            {{ dept.company.name|default:"‚Äî" }}
          </td>

          <td class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">
            {{ dept.name }}
          </td>

          {# ‡¶Ø‡¶¶‡¶ø weekly_off_day-‡¶è choices ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶®, display ‡¶¶‡ßá‡¶ñ‡¶æ‡¶® #}
          <td class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">
            {{ dept.get_weekly_off_day_display|default:dept.weekly_off_day }}
          </td>
          <td class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">
            {% if request.user.is_superuser %}
              {% if dept.device_ip %}{{ dept.device_ip }}{% else %}‚Äî{% endif %}
              {% if dept.device_port %}:{% if dept.device_port %}{{ dept.device_port }}{% endif %}{% endif %}
            {% else %}
              {% if dept.device_ip %}*******{% else %}‚Äî{% endif %}
              {% if dept.device_port %}:*******{% endif %}
            {% endif %}
          </td>

        <td class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2">
          {% if dept.in_time %}{{ dept.in_time|time:"H:i" }}{% else %}‚Äî{% endif %}
          ‚Äî 
          {% if dept.out_time %}{{ dept.out_time|time:"H:i" }}{% else %}‚Äî{% endif %}
        </td>

        <td class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2 text-center">
          {% if request.user.is_superuser %}
            <a href="{% url 'attendance_app:department_edit' dept.id %}"
              class="inline-flex items-center justify-center gap-1 text-blue-600 hover:underline">
              ‚úèÔ∏è Edit
            </a>
          {% else %}
            <button class="inline-flex items-center justify-center gap-1 text-gray-400 cursor-not-allowed" disabled>
              ‚úèÔ∏è Edit
            </button>
          {% endif %}
        </td>

          {# ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü: POST + CSRF + confirm #}
          <td class="border border-gray-300 dark:border-gray-700 px-2 sm:px-4 py-2 text-center">
            {% if request.user.is_superuser %}
              <form method="post" action="{% url 'attendance_app:department_delete' dept.id %}"
                    onsubmit="return confirm('Delete {{ dept.name }}? This action cannot be undone.');">
                {% csrf_token %}
                <button type="submit"
                        class="inline-flex items-center justify-center gap-1 text-red-600 hover:underline">
                  üóëÔ∏è Delete
                </button>
              </form>
            {% else %}
              <div x-data="{ showToast: false }" class="inline-block relative">
                <button 
                  type="button"
                  class="inline-flex items-center justify-center gap-1 text-gray-400 cursor-not-allowed"
                  @mouseenter="showToast = true" 
                  @mouseleave="showToast = false">
                  üóëÔ∏è Delete
                </button>

              </div>
            {% endif %}
          </td>

        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="text-center py-4 text-gray-600 dark:text-gray-400">
            No departments found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Pagination #}
  {% if page_obj %}
    <div class="flex items-center justify-between mt-4 text-sm text-gray-700 dark:text-gray-300">
      <div>
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
      </div>
      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a class="px-3 py-1 border dark:border-gray-700 rounded"
             href="?{% if q %}q={{ q }}&{% endif %}page={{ page_obj.previous_page_number }}">Prev</a>
        {% else %}
          <span class="px-3 py-1 border dark:border-gray-700 rounded opacity-50 cursor-not-allowed">Prev</span>
        {% endif %}

        {% if page_obj.has_next %}
          <a class="px-3 py-1 border dark:border-gray-700 rounded"
             href="?{% if q %}q={{ q }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
        {% else %}
          <span class="px-3 py-1 border dark:border-gray-700 rounded opacity-50 cursor-not-allowed">Next</span>
        {% endif %}
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
