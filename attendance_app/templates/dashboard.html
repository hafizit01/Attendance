{% extends "base.html" %}

{# ‚úÖ ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá‡¶á ‡¶∂‡ßÅ‡¶ß‡ßÅ Chart.js ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá #}
{% block charts_vendor %}
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<main class="flex-1 p-6">
  <!-- Header + Filters -->
  <div class="mb-8">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <h2 class="text-3xl font-bold animated-text will-change-transform">üìä Attendance Dashboard</h2>

      <div class="flex flex-col md:flex-row items-center gap-3">
        <form method="get" class="flex gap-2">
          <select name="department" class="p-2 border rounded">
            <option value="">All Departments</option>
            {% for dept in departments %}
            <option value="{{ dept.id }}" {% if selected_department == dept.id %}selected{% endif %}>
              {{ dept.name }}
            </option>
            {% endfor %}
          </select>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Filter</button>
        </form>

        <!-- User Menu -->
        <div x-data="{ open:false }" class="relative">
          <button @click="open=!open" class="inline-flex items-center gap-1 text-sm font-medium text-gray-700 hover:text-black">
            üë§ {{ request.user.username }}
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div x-show="open" x-transition @click.away="open=false"
               class="absolute right-0 mt-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
            <a href="{% url 'userapp:logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">üö™ Logout</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
    <div class="bg-white p-4 shadow rounded">
      <h3 class="text-gray-600">Total</h3>
      <p class="text-xl font-bold tabular-nums">{{ total_employees }}</p>
    </div>
    <div class="bg-green-100 p-4 shadow rounded">
      <h3 class="text-gray-600">Present</h3>
      <p class="text-xl font-bold tabular-nums">{{ present }}</p>
    </div>
    <div class="bg-red-100 p-4 shadow rounded">
      <h3 class="text-gray-600">Absent</h3>
      <p class="text-xl font-bold tabular-nums">{{ absent }}</p>
    </div>
    <div class="bg-yellow-100 p-4 shadow rounded">
      <h3 class="text-gray-600">Late</h3>
      <p class="text-xl font-bold tabular-nums">{{ late }}</p>
    </div>
  </div>

  <!-- Charts (lazy-init when visible) -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded shadow">
      <h3 class="text-xl mb-4 font-semibold text-center">üìà Monthly Attendance Trend</h3>
      <div class="relative w-full overflow-x-auto">
        <canvas id="trendChart" height="120" data-chart="trend"></canvas>
      </div>
    </div>

    <div class="bg-white p-6 rounded shadow">
      <h3 class="text-xl mb-4 font-semibold text-center">üìä Today‚Äôs Summary</h3>
      <div class="w-60 h-60 mx-auto">
        <canvas id="summaryChart" data-chart="summary"></canvas>
      </div>
    </div>
  </div>

  {% if messages %}
  <div class="mb-4">
    {% for message in messages %}
      <p class="text-sm text-green-700">{{ message }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Today's Attendance Table -->
  <h3 class="text-xl font-semibold mb-4 text-center animated-text will-change-transform">Today's Attendance</h3>

  <div class="overflow-x-auto bg-white p-4 rounded shadow">
    <table class="table-auto w-full text-sm text-left">
      <thead class="bg-gray-200">
        <tr class="*:*:px-4 *:*:py-2">
          <th>Employee</th>
          <th>In Time</th>
          <th>Out Time</th>
          <th>Total</th>
          <th>Late</th>
          <th>Less</th>
          <th>Over</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody">
        {% for data in employee_data %}
        <tr class="border-t {% if forloop.counter > 10 %}hidden-row hidden{% endif %}">
          <td class="px-4 py-2">{{ data.employee.name }}</td>
          <td class="px-4 py-2 tabular-nums">{{ data.in_time|default:"-" }}</td>
          <td class="px-4 py-2 tabular-nums">{{ data.out_time|default:"-" }}</td>
          <td class="px-4 py-2 tabular-nums">{{ data.total_work_time }}</td>
          <td class="px-4 py-2 tabular-nums">{{ data.late_time }}</td>
          <td class="px-4 py-2 tabular-nums">{{ data.less_time }}</td>
          <td class="px-4 py-2 tabular-nums">{{ data.over_time }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if employee_data|length > 10 %}
    <div class="text-center mt-6">
      <button id="loadMoreBtn"
              class="inline-block px-6 py-3 bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 text-white font-semibold rounded-lg shadow-lg hover:from-blue-600 hover:via-blue-700 hover:to-blue-800 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-blue-300">
        Load More
      </button>
    </div>
    {% endif %}
  </div>
</main>

<style>
  .hidden{display:none}
  .animated-text{
    background: linear-gradient(270deg,#ff0044,#00ff99,#0066ff,#ff0044);
    background-size:800% 800%;
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    animation: gradientAnimation 10s ease infinite;
  }
  @media (prefers-reduced-motion: reduce){
    .animated-text{animation:none}
  }
  @keyframes gradientAnimation{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }
</style>
{% endblock content %}

{% block extra_scripts %}
<script>
  // Lazy init charts when visible to speed up first paint
  document.addEventListener('DOMContentLoaded', function () {
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', function () {
        document.querySelectorAll('.hidden-row.hidden').forEach(row => row.classList.remove('hidden'));
        loadMoreBtn.style.display = 'none';
      });
    }

    if (typeof IntersectionObserver === 'undefined' || typeof Chart === 'undefined') {
      // Fallback: init immediately if IO or Chart missing
      initSummaryChart(); initTrendChart();
      return;
    }

    const targets = document.querySelectorAll('canvas[data-chart]');
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(e => {
        if (!e.isIntersecting) return;
        const el = e.target;
        const type = el.dataset.chart;
        if (type === 'summary') initSummaryChart();
        if (type === 'trend') initTrendChart();
        obs.unobserve(el);
      });
    }, { rootMargin: '100px' });

    targets.forEach(t => io.observe(t));

    function initSummaryChart(){
      const el = document.getElementById('summaryChart');
      if (!el || el.dataset.inited) return;
      if (typeof Chart === 'undefined') return;

      const present = Number('{{ present|default:0 }}');
      const absent  = Number('{{ absent|default:0 }}');
      const late    = Number('{{ late|default:0 }}');
      const total   = present + absent + late;
      if (!total) { el.dataset.inited = '1'; return; }

      new Chart(el.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: ['Present','Absent','Late'],
          datasets: [{
            data: [present, absent, late],
            backgroundColor:[
              'rgba(34,197,94,0.8)',
              'rgba(239,68,68,0.8)',
              'rgba(250,204,21,0.8)'
            ],
            borderColor:'#fff',
            borderWidth:2,
            hoverOffset:10
          }]
        },
        options:{ responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{legend:{display:false}} }
      });
      el.dataset.inited = '1';
    }

    function initTrendChart(){
      const el = document.getElementById('trendChart');
      if (!el || el.dataset.inited) return;
      if (typeof Chart === 'undefined') return;

      const trend = {{ attendance_trend|safe }};
      if (!Array.isArray(trend) || !trend.length){ el.dataset.inited='1'; return; }

      const labels  = trend.map(i => i.date);
      const present = trend.map(i => i.present);
      const absent  = trend.map(i => i.absent);
      const late    = trend.map(i => i.late);

      new Chart(el.getContext('2d'), {
        type:'line',
        data:{
          labels,
          datasets:[
            { label:'Present', data:present, borderColor:'rgba(34,197,94,1)',  backgroundColor:'rgba(34,197,94,0.1)',  fill:true, tension:0.3 },
            { label:'Absent',  data:absent,  borderColor:'rgba(239,68,68,1)',  backgroundColor:'rgba(239,68,68,0.1)', fill:true, tension:0.3 },
            { label:'Late',    data:late,    borderColor:'rgba(250,204,21,1)', backgroundColor:'rgba(250,204,21,0.1)', fill:true, tension:0.3 },
          ]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
      el.dataset.inited = '1';
    }
  });
</script>
{% endblock %}
