{% extends "base.html" %}

{% block content %}
<main class="w-full px-4 py-6 space-y-8 animate-in fade-in duration-500">
  
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
    <div>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
            <span class="text-3xl">ðŸ“Š</span> Attendance Dashboard
        </h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Overview of today's attendance & monthly trends.</p>
    </div>

    <form method="get" class="flex flex-wrap items-center gap-3 w-full md:w-auto bg-gray-50 dark:bg-gray-700/50 p-2 rounded-xl">
        <select name="department"
                class="bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-none text-sm rounded-lg focus:ring-2 focus:ring-blue-500 px-4 py-2.5 shadow-sm outline-none w-full sm:w-auto">
            <option value="">All Departments</option>
            {% for dept in departments %}
            <option value="{{ dept.id }}" {% if selected_department == dept.id %}selected{% endif %}>
                {{ dept.name }}
            </option>
            {% endfor %}
        </select>
        <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm px-6 py-2.5 rounded-lg shadow-lg shadow-blue-200 dark:shadow-none transition-all w-full sm:w-auto">
            Apply Filter
        </button>
    </form>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6">
    <div class="relative overflow-hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 group hover:scale-[1.02] transition-transform duration-300">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-blue-50 dark:bg-blue-900/20 rounded-full blur-2xl"></div>
        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Total Employees</h3>
        <p class="text-3xl font-extrabold text-gray-800 dark:text-white tabular-nums group-hover:text-blue-600 transition-colors">{{ total_employees }}</p>
    </div>

    <div class="relative overflow-hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 group hover:scale-[1.02] transition-transform duration-300">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-emerald-50 dark:bg-emerald-900/20 rounded-full blur-2xl"></div>
        <h3 class="text-xs font-bold text-emerald-600/70 uppercase tracking-widest mb-2">Present Today</h3>
        <p class="text-3xl font-extrabold text-emerald-600 tabular-nums">{{ present }}</p>
    </div>

    <div class="relative overflow-hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 group hover:scale-[1.02] transition-transform duration-300">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-rose-50 dark:bg-rose-900/20 rounded-full blur-2xl"></div>
        <h3 class="text-xs font-bold text-rose-500/70 uppercase tracking-widest mb-2">Absent Today</h3>
        <p class="text-3xl font-extrabold text-rose-500 tabular-nums">{{ absent }}</p>
    </div>

    <div class="relative overflow-hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 group hover:scale-[1.02] transition-transform duration-300">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-amber-50 dark:bg-amber-900/20 rounded-full blur-2xl"></div>
        <h3 class="text-xs font-bold text-amber-500/70 uppercase tracking-widest mb-2">Late Today</h3>
        <p class="text-3xl font-extrabold text-amber-500 tabular-nums">{{ late }}</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
      <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
              <span class="w-2 h-6 bg-blue-500 rounded-full"></span>
              Monthly Trend
          </h3>
          <span class="text-xs font-medium text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Last 30 Days</span>
      </div>
      <div class="relative h-64 w-full">
        <canvas id="trendChart"></canvas>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center">
      <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-6 text-center">Today's Summary</h3>
      <div class="w-48 h-48 relative">
        <canvas id="summaryChart"></canvas>
        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
            <span class="text-sm text-gray-400">Total</span>
            <span class="text-xl font-bold text-gray-800 dark:text-white">{{ total_employees }}</span>
        </div>
      </div>
    </div>
  </div>

  {% if messages %}
  <div class="space-y-2">
    {% for message in messages %}
      <div class="p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 text-sm font-medium border border-blue-100 dark:border-blue-800">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden">
    <div class="p-6 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
            <span class="text-xl">ðŸ“‹</span> Today's Attendance Log
        </h3>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left">
        <thead class="bg-gray-50 dark:bg-gray-700/50 text-gray-500 dark:text-gray-400 uppercase text-xs font-bold tracking-wider">
          <tr>
            <th class="px-6 py-4">Employee</th>
            <th class="px-6 py-4">In Time</th>
            <th class="px-6 py-4">Out Time</th>
            <th class="px-6 py-4 text-center">Total</th>
            <th class="px-6 py-4 text-center">Late</th>
            <th class="px-6 py-4 text-center">Less</th>
            <th class="px-6 py-4 text-center">Over</th>
            <th class="px-6 py-4 text-center">Status</th>
          </tr>
        </thead>
        <tbody id="employeeTableBody" class="divide-y divide-gray-100 dark:divide-gray-700">
          {% for data in employee_data %}
          <tr class="group hover:bg-blue-50/50 dark:hover:bg-blue-900/10 transition-colors {% if forloop.counter > 10 %}hidden-row hidden{% endif %}">
            <td class="px-6 py-4 font-medium text-gray-900 dark:text-gray-100">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-xs font-bold text-gray-500">
                        {{ data.employee.name|slice:":1" }}
                    </div>
                    {{ data.employee.name }}
                </div>
            </td>
            <td class="px-6 py-4 tabular-nums text-gray-600 dark:text-gray-300">
                {% if data.in_time %}
                    <span class="bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-1 rounded text-xs font-bold">{{ data.in_time }}</span>
                {% else %}-{% endif %}
            </td>
            <td class="px-6 py-4 tabular-nums text-gray-600 dark:text-gray-300">
                {% if data.out_time %}
                    <span class="bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 px-2 py-1 rounded text-xs font-bold">{{ data.out_time }}</span>
                {% else %}-{% endif %}
            </td>
            <td class="px-6 py-4 text-center tabular-nums font-mono text-gray-500">{{ data.total_work_time }}</td>
            <td class="px-6 py-4 text-center tabular-nums font-mono text-amber-600">{{ data.late_time }}</td>
            <td class="px-6 py-4 text-center tabular-nums font-mono text-rose-500">{{ data.less_time }}</td>
            <td class="px-6 py-4 text-center tabular-nums font-mono text-purple-600">{{ data.over_time }}</td>
            <td class="px-6 py-4 text-center">
                {% if data.status == 'Present' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">
                        Completed
                    </span>
                {% elif data.status == 'Present (Active)' %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 animate-pulse">
                        Active
                    </span>
                {% else %}
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                        Absent
                    </span>
                {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if employee_data|length > 10 %}
    <div class="p-4 border-t border-gray-100 dark:border-gray-700 text-center bg-gray-50 dark:bg-gray-800/50">
      <button id="loadMoreBtn"
              class="inline-flex items-center gap-2 px-6 py-2.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-semibold text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 transition shadow-sm">
        Load More Records
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
      </button>
    </div>
    {% endif %}
  </div>
</main>

<style>
  .hidden { display: none; }
</style>
{% endblock content %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Load More Logic
  const loadMoreBtn = document.getElementById("loadMoreBtn");
  if (loadMoreBtn) {
    const hiddenRows = document.querySelectorAll("#employeeTableBody .hidden-row");
    let visibleCount = 10;

    loadMoreBtn.addEventListener("click", function() {
      let shown = 0;
      for (let i = visibleCount; i < hiddenRows.length && shown < 10; i++) {
        hiddenRows[i].classList.remove("hidden");
        hiddenRows[i].classList.add("animate-in", "fade-in", "slide-in-from-bottom-2");
        shown++;
      }
      visibleCount += shown;
      if (visibleCount >= hiddenRows.length) {
        loadMoreBtn.style.display = "none";
      }
    });
  }

  // Chart Logic
  try {
    const raw = '{{ attendance_trend_json|escapejs }}';
    const attendanceTrend = raw ? JSON.parse(raw) : [];
    
    const labels = attendanceTrend.map(i => i.date);
    const presentData = attendanceTrend.map(i => Number(i.present || 0));
    const absentData = attendanceTrend.map(i => Number(i.absent || 0));
    const lateData = attendanceTrend.map(i => Number(i.late || 0));

    // Trend Chart
    const trendCtx = document.getElementById('trendChart')?.getContext('2d');
    if (trendCtx) {
      // Gradient for Present
      const gradientPresent = trendCtx.createLinearGradient(0, 0, 0, 400);
      gradientPresent.addColorStop(0, 'rgba(34, 197, 94, 0.2)');
      gradientPresent.addColorStop(1, 'rgba(34, 197, 94, 0)');

      new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Present',
              data: presentData,
              borderColor: '#22c55e',
              backgroundColor: gradientPresent,
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#fff',
              pointBorderColor: '#22c55e',
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'Absent',
              data: absentData,
              borderColor: '#f43f5e',
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 4
            },
            {
              label: 'Late',
              data: lateData,
              borderColor: '#f59e0b',
              backgroundColor: 'transparent',
              tension: 0.4,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8 } },
            tooltip: {
                backgroundColor: 'rgba(17, 24, 39, 0.9)',
                titleFont: { size: 13 },
                bodyFont: { size: 13 },
                padding: 10,
                cornerRadius: 8,
                displayColors: true
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { font: { size: 10 } } },
            y: { beginAtZero: true, grid: { color: '#f3f4f6' }, border: { display: false } }
          }
        }
      });
    }

    // Pie Chart
    const todaySummary = {
      present: Number({{ present|default:0 }}),
      absent: Number({{ absent|default:0 }}),
      late:   Number({{ late|default:0 }})
    };

    const summaryCtx = document.getElementById('summaryChart')?.getContext('2d');
    if (summaryCtx) {
      new Chart(summaryCtx, {
        type: 'doughnut',
        data: {
          labels: ['Present', 'Absent', 'Late'],
          datasets: [{
            data: [todaySummary.present, todaySummary.absent, todaySummary.late],
            backgroundColor: ['#22c55e', '#f43f5e', '#f59e0b'],
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          cutout: '75%',
          plugins: { legend: { display: false } }
        }
      });
    }

  } catch (err) {
    console.error("Chart Error:", err);
  }
});
</script>
{% endblock %}