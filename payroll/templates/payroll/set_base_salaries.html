{% extends "base.html" %}
{% block content %}

<!-- Page Wrapper -->
<div class="mx-auto max-w-6xl p-4 sm:p-6">
  <!-- Sticky Header / Filters -->
  <div class="sticky top-0 z-30 -mx-4 sm:-mx-6 px-4 sm:px-6 pt-4 pb-3 bg-white/80 dark:bg-gray-900/80 backdrop-blur border-b dark:border-gray-700">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight dark:text-gray-100">ğŸ§¾ Employee Salaries & Bonus</h1>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Set base salary, bank transfer, and yearly bonus for employees in your company scope.</p>
      </div>

      <!-- Search / Per-Page Controls -->
      <form method="get" class="grid grid-cols-1 sm:grid-cols-10 gap-2 w-full sm:w-auto sm:min-w-[520px]">
        <input type="hidden" name="page" value="{{ page_obj.number }}" />
        <div class="sm:col-span-7">
          <input id="q" name="q" value="{{ q }}" placeholder="ğŸ” Search by name or device user IDâ€¦"
                 class="w-full border dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-emerald-500 focus:outline-none" />
        </div>
        <div class="sm:col-span-3 flex items-center gap-2">
          <label for="per" class="text-sm text-gray-600 dark:text-gray-400">Per page</label>
          <select id="per" name="per" class="border dark:border-gray-700 rounded-lg px-2 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-emerald-500">
            {% for n in per_choices %}
              <option value="{{ n }}" {% if per == n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
          <button class="ml-auto bg-gray-900 hover:bg-gray-800 text-white px-4 py-2 rounded-lg">Apply</button>
        </div>
      </form>
    </div>

    <!-- Meta -->
    <div class="mt-2 text-xs text-gray-600 dark:text-gray-400">
      Showing <span class="font-medium">{{ employees|length }}</span> on page <span class="font-medium">{{ page_obj.number }}</span>
      {% if page_obj.paginator.num_pages %} / {{ page_obj.paginator.num_pages }}{% endif %}
    </div>
  </div>

  <!-- Form -->
  <form method="post" id="salary-form" class="mt-4">
    {% csrf_token %}

    <!-- Save Bar -->
    <div id="save-bar" class="sticky top-[68px] z-20 hidden">
      <div class="mx-auto max-w-6xl bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-700 rounded-xl px-4 py-3 flex items-center justify-between shadow-sm">
        <p class="text-sm text-emerald-900 dark:text-emerald-200">
          <span class="font-semibold" id="changes-count">0</span> field(s) changed on this page.
        </p>
        <div class="flex items-center gap-2">
          <button type="button" id="reset-btn" class="px-3 py-2 rounded-lg border border-emerald-300 dark:border-emerald-700 text-emerald-900 dark:text-emerald-200 hover:bg-emerald-100 dark:hover:bg-emerald-800">Reset page</button>
          <button type="submit" class="px-5 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white shadow">ğŸ’¾ Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Employee Cards -->
    <div class="grid gap-4 sm:gap-5 lg:gap-6">
      {% for emp in employees %}
        <section class="rounded-2xl border bg-white dark:bg-gray-900 dark:border-gray-700 shadow-sm hover:shadow-md transition p-4 sm:p-5">
          <header class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-lg sm:text-xl font-semibold flex items-center gap-2 dark:text-gray-100">
                <span class="text-gray-400">#{{ forloop.counter }}</span>
                <span>{{ emp.name }}</span>
              </h2>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                {% if emp.department %}Dept: {{ emp.department.name }} Â· {% endif %}
                ID: {{ emp.id }}{% if emp.device_user_id %} Â· Device: {{ emp.device_user_id }}{% endif %}
              </p>
            </div>
          </header>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Base Salary -->
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">ğŸ’° Base Salary (Tk)</label>
              <input type="number" step="0.01" min="0" inputmode="decimal" name="salary_{{ emp.id }}"
                     value="{{ emp.employeesalary.base_salary|default_if_none:'0.00' }}"
                     class="w-full border dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-emerald-500"
                     data-field="base" data-emp="{{ emp.id }}">
              <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Required. Use decimals as needed.</p>
            </div>

            <!-- Bank Transfer -->
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">ğŸ¦ Bank Transfer (Tk)</label>
              <input type="number" step="0.01" min="0" inputmode="decimal" name="bank_transfer_{{ emp.id }}"
                     value="{{ emp.employeesalary.bank_transfer_amount|default_if_none:'0.00' }}"
                     class="w-full border dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-emerald-500"
                     data-field="bank" data-emp="{{ emp.id }}">
              <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Must be â‰¤ Base Salary. Auto-adjusts.</p>
            </div>

            <!-- Bonus % -->
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">ğŸ Bonus (%)</label>
              <input type="number" step="0.01" min="0" inputmode="decimal" name="bonus_percent_{{ emp.id }}"
                     value="{{ emp.employeesalary.yearly_bonus_percent|default_if_none:'0.00' }}"
                     class="w-full border dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-emerald-500">
              <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Percentage of annual base.</p>
            </div>

            <!-- Bonus Fixed -->
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">ğŸ Bonus (Fixed Tk)</label>
              <input type="number" step="0.01" min="0" inputmode="decimal" name="bonus_fixed_{{ emp.id }}"
                     value="{{ emp.employeesalary.yearly_bonus_fixed|default_if_none:'0.00' }}"
                     class="w-full border dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-emerald-500">
              <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Flat amount bonus.</p>
            </div>

            <!-- Bonus Month -->
            <div>
              <label class="block text-sm font-medium mb-1 dark:text-gray-300">ğŸ“… Bonus Month</label>
              <select name="bonus_month_{{ emp.id }}" class="w-full border dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-emerald-500">
                {% for val,label in month_choices %}
                  <option value="{{ val }}" {% if emp.employeesalary and emp.employeesalary.bonus_payout_month == val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Default is December.</p>
            </div>
          </div>
        </section>
      {% endfor %}
    </div>

    <!-- Bottom Pagination + Save -->
    <div class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-3">
      <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
        <span>Page</span>
        <div class="inline-flex rounded-lg border dark:border-gray-700 overflow-hidden">
          {% if page_obj.has_previous %}
            <a href="?q={{ q }}&per={{ per }}&page={{ page_obj.previous_page_number }}" class="px-3 py-2 hover:bg-gray-50 dark:hover:bg-gray-800">Prev</a>
          {% else %}
            <span class="px-3 py-2 text-gray-400">Prev</span>
          {% endif %}
          <span class="px-3 py-2 border-l dark:border-gray-700 bg-gray-50 dark:bg-gray-800">{{ page_obj.number }}</span>
          {% if page_obj.has_next %}
            <a href="?q={{ q }}&per={{ per }}&page={{ page_obj.next_page_number }}" class="px-3 py-2 border-l dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">Next</a>
          {% else %}
            <span class="px-3 py-2 border-l dark:border-gray-700 text-gray-400">Next</span>
          {% endif %}
        </div>
        <span>of {{ page_obj.paginator.num_pages }}</span>
      </div>

      <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-xl shadow">ğŸ’¾ Save All</button>
    </div>
  </form>
</div>

<!-- Script -->
<script>
(function(){
  const form = document.getElementById('salary-form');
  const saveBar = document.getElementById('save-bar');
  const changesCountEl = document.getElementById('changes-count');
  const resetBtn = document.getElementById('reset-btn');
  if(!form) return;

  const initial = new Map();
  const inputs = Array.from(form.querySelectorAll('input, select'));
  inputs.forEach(el => initial.set(el.name, el.value));

  function updateChanged() {
    let changed = 0;
    inputs.forEach(el => { if(initial.get(el.name) !== el.value) changed++; });
    changesCountEl.textContent = changed;
    saveBar.classList.toggle('hidden', changed === 0);
  }

  // Clamp bank transfer to â‰¤ base salary
  function clampFor(empId){
    const base = form.querySelector(`[name="salary_${empId}"]`);
    const bank = form.querySelector(`[name="bank_transfer_${empId}"]`);
    if(!base || !bank) return;
    const b = parseFloat(base.value || '0');
    let k = parseFloat(bank.value || '0');
    if(k > b){ bank.value = b.toFixed(2); }
  }

  form.addEventListener('input', (e)=>{
    const t = e.target;
    if(t && t.dataset && t.dataset.emp){ clampFor(t.dataset.emp); }
    updateChanged();
  });

  resetBtn?.addEventListener('click', ()=>{
    inputs.forEach(el => { el.value = initial.get(el.name); });
    updateChanged();
  });

  updateChanged();
})();
</script>

{% endblock %}
