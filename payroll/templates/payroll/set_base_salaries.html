{% extends "base.html" %}
{% block content %}

<div class="mx-auto max-w-[1400px] p-4 sm:p-6 space-y-6">
  
  <div class="flex flex-col lg:flex-row justify-between items-end gap-4 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
    <div class="w-full lg:w-auto">
      <h1 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-gray-100 flex items-center gap-2">
        <span>ðŸ’°</span> Set Base Salaries & Bonuses
      </h1>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
        Showing {{ employees|length }} employees. (Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }})
      </p>
    </div>

    <form method="get" class="flex flex-wrap gap-2 w-full lg:w-auto items-center">
      <input type="hidden" name="page" value="{{ page_obj.number }}" />
      
      <div class="relative">
        <select name="per" onchange="this.form.submit()" class="appearance-none pl-3 pr-8 py-2.5 bg-gray-50 dark:bg-gray-700 border-0 rounded-lg text-sm font-medium focus:ring-2 focus:ring-emerald-500 cursor-pointer">
          {% for n in per_choices %}
            <option value="{{ n }}" {% if per == n %}selected{% endif %}>{{ n }} rows</option>
          {% endfor %}
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
      </div>

      <div class="relative flex-grow lg:flex-grow-0 lg:w-72">
        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
          <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
        </div>
        <input type="text" name="q" value="{{ q }}" placeholder="Search name or ID..." 
               class="block w-full rounded-lg border-0 bg-gray-50 dark:bg-gray-700 py-2.5 pl-10 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 focus:ring-2 focus:ring-emerald-500 sm:text-sm">
      </div>
      
      <button type="submit" class="bg-gray-900 dark:bg-gray-600 text-white px-4 py-2.5 rounded-lg hover:bg-gray-800 transition shadow-sm font-medium text-sm">Search</button>
    </form>
  </div>

  <form method="post" id="salary-form" class="relative">
    {% csrf_token %}

    <div id="save-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden transition-all duration-300 transform translate-y-20 opacity-0 data-[visible=true]:translate-y-0 data-[visible=true]:opacity-100">
      <div class="bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-4 border border-gray-700">
        <span class="text-sm font-medium"><span id="changes-count" class="text-emerald-400 font-bold text-lg">0</span> changes made</span>
        <div class="h-4 w-px bg-gray-700"></div>
        <button type="button" id="reset-btn" class="text-sm text-gray-300 hover:text-white transition">Reset</button>
        <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-1.5 rounded-full text-sm font-bold shadow-lg transition transform hover:scale-105">Save Changes</button>
      </div>
    </div>

    <div class="hidden md:block bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-gray-50 dark:bg-gray-700/50 border-b border-gray-200 dark:border-gray-700 text-xs uppercase text-gray-500 dark:text-gray-400 font-semibold tracking-wider">
              <th class="p-4 sticky left-0 bg-gray-50 dark:bg-gray-800 z-10 w-64">Employee</th>
              <th class="p-4 text-center w-40 text-blue-600 dark:text-blue-400 bg-blue-50/50 dark:bg-blue-900/10">Base Salary</th>
              <th class="p-4 text-center w-40 text-purple-600 dark:text-purple-400 bg-purple-50/50 dark:bg-purple-900/10">Bank Transfer</th>
              <th class="p-4 text-center w-32">Bonus %</th>
              <th class="p-4 text-center w-36">Fixed Bonus</th>
              <th class="p-4 text-center w-40">Payout Month</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-700 text-sm">
            {% for emp in employees %}
            <tr class="group hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
              <td class="p-4 sticky left-0 bg-white dark:bg-gray-800 group-hover:bg-gray-50 dark:group-hover:bg-gray-700/50 z-10 border-r border-transparent group-hover:border-gray-200 dark:group-hover:border-gray-700">
                <div class="flex items-center gap-3">
                  <div class="h-9 w-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs shadow-sm">
                    {{ emp.name|slice:":1" }}
                  </div>
                  <div>
                    <div class="font-bold text-gray-900 dark:text-white">{{ emp.name }}</div>
                    <div class="text-xs text-gray-500">{{ emp.device_user_id }} | {{ emp.department.name|default:"-" }}</div>
                  </div>
                </div>
              </td>

              <td class="p-3 bg-blue-50/10 dark:bg-blue-900/5">
                <div class="relative rounded-md shadow-sm">
                  <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                    <span class="text-gray-400 sm:text-sm">à§³</span>
                  </div>
                  <input type="number" step="0.01" name="salary_{{ emp.id }}" data-emp="{{ emp.id }}"
                         value="{{ emp.employeesalary.base_salary|default_if_none:'' }}" placeholder="0"
                         class="block w-full rounded-md border-0 py-2 pl-7 pr-2 text-gray-900 dark:text-white ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6 bg-white dark:bg-gray-900 text-right font-mono">
                </div>
              </td>

              <td class="p-3 bg-purple-50/10 dark:bg-purple-900/5">
                <div class="relative rounded-md shadow-sm">
                  <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                    <span class="text-gray-400 sm:text-sm">à§³</span>
                  </div>
                  <input type="number" step="0.01" name="bank_transfer_{{ emp.id }}" data-emp="{{ emp.id }}"
                         value="{{ emp.employeesalary.bank_transfer_amount|default_if_none:'' }}" placeholder="0"
                         class="block w-full rounded-md border-0 py-2 pl-7 pr-2 text-gray-900 dark:text-white ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-purple-600 sm:text-sm sm:leading-6 bg-white dark:bg-gray-900 text-right font-mono">
                </div>
              </td>

              <td class="p-3">
                <div class="relative rounded-md shadow-sm group/bonus">
                  <input type="number" step="0.01" name="bonus_percent_{{ emp.id }}" placeholder="0"
                         value="{{ emp.employeesalary.yearly_bonus_percent|default_if_none:'' }}"
                         class="block w-full rounded-md border-0 py-2 pl-3 pr-8 text-gray-900 dark:text-white ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6 bg-white dark:bg-gray-900 text-center disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:text-gray-400 transition-all">
                  <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                    <span class="text-gray-400 sm:text-sm">%</span>
                  </div>
                </div>
              </td>

              <td class="p-3">
                <div class="relative rounded-md shadow-sm">
                  <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                    <span class="text-gray-400 sm:text-sm">à§³</span>
                  </div>
                  <input type="number" step="0.01" name="bonus_fixed_{{ emp.id }}" placeholder="0"
                         value="{{ emp.employeesalary.yearly_bonus_fixed|default_if_none:'' }}"
                         class="block w-full rounded-md border-0 py-2 pl-7 pr-2 text-gray-900 dark:text-white ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-sm sm:leading-6 bg-white dark:bg-gray-900 text-right font-mono disabled:bg-gray-100 dark:disabled:bg-gray-800 disabled:text-gray-400 transition-all">
                </div>
              </td>

              <td class="p-3">
                <select name="bonus_month_{{ emp.id }}" class="block w-full rounded-md border-0 py-2 pl-3 pr-8 text-gray-900 dark:text-white ring-1 ring-inset ring-gray-300 dark:ring-gray-600 focus:ring-2 focus:ring-inset focus:ring-emerald-600 sm:text-xs sm:leading-6 bg-white dark:bg-gray-900">
                  {% for val,label in month_choices %}
                    <option value="{{ val }}" {% if emp.employeesalary.bonus_payout_month == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="md:hidden space-y-4">
      {% for emp in employees %}
      <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-3 mb-4 border-b border-gray-100 dark:border-gray-700 pb-3">
            <div class="h-10 w-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">{{ emp.name|slice:":1" }}</div>
            <div>
                <h3 class="font-bold text-gray-900 dark:text-white">{{ emp.name }}</h3>
                <p class="text-xs text-gray-500">ID: {{ emp.device_user_id }}</p>
            </div>
        </div>
        
        <div class="space-y-3">
            <div>
                <label class="text-xs font-semibold text-blue-600 dark:text-blue-400 uppercase">Base Salary</label>
                <div class="relative mt-1">
                    <span class="absolute left-3 top-2.5 text-gray-400">à§³</span>
                    <input type="number" name="salary_{{ emp.id }}" data-emp="{{ emp.id }}" value="{{ emp.employeesalary.base_salary|default_if_none:'' }}" class="w-full pl-8 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600 py-2 font-mono">
                </div>
            </div>
            <div>
                <label class="text-xs font-semibold text-purple-600 dark:text-purple-400 uppercase">Bank Transfer</label>
                <div class="relative mt-1">
                    <span class="absolute left-3 top-2.5 text-gray-400">à§³</span>
                    <input type="number" name="bank_transfer_{{ emp.id }}" data-emp="{{ emp.id }}" value="{{ emp.employeesalary.bank_transfer_amount|default_if_none:'' }}" class="w-full pl-8 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600 py-2 font-mono">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-xs text-gray-500">Bonus %</label>
                    <div class="relative">
                        <input type="number" name="bonus_percent_{{ emp.id }}" value="{{ emp.employeesalary.yearly_bonus_percent|default_if_none:'' }}" class="w-full rounded-lg border-gray-300 dark:bg-gray-700 py-2 pr-6 text-center disabled:bg-gray-100">
                        <span class="absolute right-3 top-2.5 text-gray-400">%</span>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-500">Fixed Bonus</label>
                    <div class="relative">
                        <span class="absolute left-2 top-2.5 text-gray-400">à§³</span>
                        <input type="number" name="bonus_fixed_{{ emp.id }}" value="{{ emp.employeesalary.yearly_bonus_fixed|default_if_none:'' }}" class="w-full pl-6 rounded-lg border-gray-300 dark:bg-gray-700 py-2 text-right disabled:bg-gray-100">
                    </div>
                </div>
            </div>
        </div>
      </div>
      {% endfor %}
    </div>

  </form>

  {% if page_obj.paginator.num_pages > 1 %}
  <div class="flex justify-center pt-6">
    <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
      {% if page_obj.has_previous %}
      <a href="?q={{ q }}&per={{ per }}&page={{ page_obj.previous_page_number }}" class="relative inline-flex items-center rounded-l-md px-4 py-2 text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 bg-white dark:bg-gray-800 dark:text-gray-200 dark:ring-gray-700">Prev</a>
      {% endif %}
      
      <span class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-700 ring-1 ring-inset ring-gray-300 focus:outline-offset-0 bg-white dark:bg-gray-800 dark:text-gray-200 dark:ring-gray-700">
        Page {{ page_obj.number }}
      </span>

      {% if page_obj.has_next %}
      <a href="?q={{ q }}&per={{ per }}&page={{ page_obj.next_page_number }}" class="relative inline-flex items-center rounded-r-md px-4 py-2 text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 bg-white dark:bg-gray-800 dark:text-gray-200 dark:ring-gray-700">Next</a>
      {% endif %}
    </nav>
  </div>
  {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('salary-form');
  const saveBar = document.getElementById('save-bar');
  const changesCountEl = document.getElementById('changes-count');
  const resetBtn = document.getElementById('reset-btn');

  // 1. Change Tracking Logic
  const initial = new Map();
  const inputs = Array.from(form.querySelectorAll('input, select'));
  inputs.forEach(el => initial.set(el.name, el.value));

  function updateChanged() {
    let changed = 0;
    inputs.forEach(el => {
      // Check if value changed (ignoring empty strings vs nulls)
      if ((initial.get(el.name) || '') !== (el.value || '')) changed++;
    });
    
    changesCountEl.textContent = changed;
    
    if (changed > 0) {
      saveBar.classList.remove('hidden');
      setTimeout(() => saveBar.setAttribute('data-visible', 'true'), 10); // Trigger animation
    } else {
      saveBar.setAttribute('data-visible', 'false');
      setTimeout(() => saveBar.classList.add('hidden'), 300);
    }
  }

  // 2. Bonus Mutual Exclusion Logic (Locking)
  function handleBonusLock(empId) {
    const percent = document.querySelector(`input[name="bonus_percent_${empId}"]`);
    const fixed = document.querySelector(`input[name="bonus_fixed_${empId}"]`);
    if (!percent || !fixed) return;

    const pVal = parseFloat(percent.value) || 0;
    const fVal = parseFloat(fixed.value) || 0;

    // Remove previous disabled states first
    percent.disabled = false;
    fixed.disabled = false;
    percent.parentElement.classList.remove('opacity-50');
    fixed.parentElement.classList.remove('opacity-50');

    if (pVal > 0) {
      fixed.disabled = true;
      fixed.value = ''; // Optional: clear value
      fixed.parentElement.classList.add('opacity-50');
    } else if (fVal > 0) {
      percent.disabled = true;
      percent.value = ''; // Optional: clear value
      percent.parentElement.classList.add('opacity-50');
    }
  }

  // 3. Bank Transfer Clamping
  function clampBank(target) {
    if (!target.dataset.emp) return;
    const empId = target.dataset.emp;
    const baseEl = document.querySelector(`input[name="salary_${empId}"]`);
    const bankEl = document.querySelector(`input[name="bank_transfer_${empId}"]`);
    
    if(baseEl && bankEl) {
        const baseVal = parseFloat(baseEl.value) || 0;
        const bankVal = parseFloat(bankEl.value) || 0;
        if(bankVal > baseVal) {
            bankEl.classList.add('text-red-600', 'font-bold'); // Visual warning
        } else {
            bankEl.classList.remove('text-red-600', 'font-bold');
        }
    }
  }

  // Event Listeners
  form.addEventListener('input', (e) => {
    updateChanged();
    
    // Extract ID for bonus logic
    const name = e.target.name;
    const id = name.split('_').pop();
    
    if (name.includes('bonus')) {
      handleBonusLock(id);
    }
    
    if (name.includes('salary') || name.includes('bank')) {
        clampBank(e.target);
    }
  });

  resetBtn.addEventListener('click', () => {
    inputs.forEach(el => {
      el.value = initial.get(el.name);
      // Reset disabled states
      const id = el.name.split('_').pop();
      if(el.name.includes('bonus')) handleBonusLock(id);
    });
    updateChanged();
  });

  // Init checks on load
  const processedIds = new Set();
  inputs.forEach(el => {
    const id = el.name.split('_').pop();
    if (el.name.includes('bonus') && !processedIds.has(id)) {
      handleBonusLock(id);
      processedIds.add(id);
    }
  });

});
</script>

{% endblock %}