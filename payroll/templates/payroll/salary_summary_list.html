{% extends 'base.html' %}

{% block content %}
<h2 class="text-2xl md:text-3xl font-semibold mb-4 text-gray-800 dark:text-gray-100 text-center">
  ðŸ§¾ Salary Summary List
</h2>

<div class="mt-4 text-right">
  {% if summaries %}
    <a href="{% url 'payroll:salary_summary_pdf' %}?month={{ selected_month }}&department={{ selected_department_id }}&employee={{ selected_employee_id }}"
       class="inline-flex items-center bg-green-600 text-white px-4 py-2 rounded-md shadow hover:bg-green-700 transition duration-150"
       target="_blank">ðŸ“„ Export PDF</a>
  {% else %}
    <button class="inline-flex items-center bg-gray-300 text-gray-600 px-4 py-2 rounded-md shadow cursor-not-allowed" disabled>
      ðŸ“„ Export PDF (No Data)
    </button>
  {% endif %}
</div>

<!-- Filters -->
<form method="get" class="bg-white dark:bg-gray-900 dark:text-gray-200 p-6 rounded-lg shadow-md mb-6">
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
      <label for="month" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Month:</label>
      <input type="month" id="month" name="month" value="{{ selected_month }}"
             class="w-full border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 px-3 py-2">
    </div>

    <div>
      <label for="department" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Department:</label>
      <select id="department" name="department"
              class="w-full border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 px-3 py-2">
        <option value="">All Departments</option>
        {% for dept in departments %}
          <option value="{{ dept.id }}" {% if dept.id|stringformat:"s" == selected_department_id %}selected{% endif %}>
            {{ dept.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label for="employee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Employee:</label>
      <select id="employee" name="employee"
              class="w-full border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 px-3 py-2">
        <option value="">All Employees</option>
        {% for emp in employees %}
          <option value="{{ emp.id }}" {% if emp.id|stringformat:"s" == selected_employee_id %}selected{% endif %}>
            {{ emp.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="flex items-end">
      <button type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-md transition shadow">
        ðŸ“Š Show Report
      </button>
    </div>
  </div>
</form>

{% load custom_filters %}

{% if summaries %}
  <!-- âœ… à¦¶à§à¦§à§ horizontal scroll: overflow-x-auto; à¦•à§‹à¦¨ max-h/overflow-auto à¦¨à§‡à¦‡ -->
  <div class="overflow-x-auto rounded-lg border border-gray-300 dark:border-gray-700">
    <!-- âœ… à¦Ÿà§‡à¦¬à¦¿à¦²à¦•à§‡ à¦¬à§œ à¦•à¦°à¦¾ à¦¹à§Ÿà§‡à¦›à§‡ à¦¯à§‡à¦¨ à¦¡à¦¾à¦¨à§‡-à¦¬à¦¾à¦®à§‡ à¦¸à§à¦•à§à¦°à¦² à¦†à¦¸à§‡ -->
    <table class="min-w-[1400px] lg:min-w-[1600px] divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-100 dark:bg-gray-800">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">#</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Employee</th>
          <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Month</th>

          <!-- à¦Ÿà¦¾à¦•à¦¾/à¦¸à¦‚à¦–à§à¦¯à¦¾ à¦•à¦²à¦¾à¦®: nowrap + tabular-nums + right -->
          <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Base Salary</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Bank Transfer</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Cash Amount</th>

          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Present</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Leave</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Absent</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Weekly Off</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Public Holidays</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Late Time</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Over Time</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Total Work</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Expected Work</th>
          <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Diff</th>

          <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Earned Salary</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border whitespace-nowrap">Bonus</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-green-600 uppercase border whitespace-nowrap">Final Salary</th>
          <th class="px-4 py-2 text-right text-xs font-medium text-red-600 uppercase border whitespace-nowrap">Payable Cash</th>
        </tr>
      </thead>

      <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
        {% for s in summaries %}
        <tr class="odd:bg-white even:bg-gray-50 dark:odd:bg-gray-900 dark:even:bg-gray-800 hover:bg-blue-50 dark:hover:bg-gray-700 transition">
          <td class="px-4 py-2 border">{{ forloop.counter }}</td>
          <td class="px-4 py-2 border">{{ s.employee.name }}</td>
          <td class="px-4 py-2 border whitespace-nowrap">{{ s.month }}</td>

          <td class="px-4 py-2 border text-right tabular-nums whitespace-nowrap">à§³ {{ s.base_salary|floatformat:2 }}</td>
          <td class="px-4 py-2 border text-right tabular-nums whitespace-nowrap">à§³ {{ s.bank_transfer|floatformat:2 }}</td>
          <td class="px-4 py-2 border text-right tabular-nums whitespace-nowrap">à§³ {{ s.cash_amount|floatformat:2 }}</td>

          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.present_days }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.leave_days }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.absent_days }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.weekly_off_days }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.holiday_days }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.late_time }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.over_time|format_timedelta }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.total_work_hours }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.expected_work_hours }}</td>
          <td class="px-4 py-2 border text-center tabular-nums whitespace-nowrap">{{ s.work_time_difference }}</td>

          <td class="px-4 py-2 border text-right tabular-nums whitespace-nowrap">à§³ {{ s.earned_salary|floatformat:2 }}</td>
          <td class="px-4 py-2 border text-right tabular-nums whitespace-nowrap">
            {% if s.bonus_amount and s.bonus_amount|floatformat:2 != "0.00" %}
              <span class="inline-flex items-center rounded-full bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 text-xs font-medium px-2 py-0.5">
                à§³ {{ s.bonus_amount|floatformat:2 }}
              </span>
            {% else %}
              à§³ 0.00
            {% endif %}
          </td>
          <td class="px-4 py-2 border font-semibold text-green-700 dark:text-green-400 text-right tabular-nums whitespace-nowrap">à§³ {{ s.final_salary|floatformat:2 }}</td>
          <td class="px-4 py-2 border font-semibold text-red-700 dark:text-red-400 text-right tabular-nums whitespace-nowrap">à§³ {{ s.payable_cash|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </tbody>

      <tfoot class="bg-gray-100 dark:bg-gray-800 font-semibold">
        <tr>
          <td colspan="3" class="px-4 py-2 border text-right">Basic Salary Total:</td>
          <td class="px-4 py-2 border text-blue-700 dark:text-blue-400 font-bold text-right tabular-nums whitespace-nowrap">à§³ {{ total_base_salary|floatformat:2 }}</td>
          <td class="px-4 py-2 border text-blue-700 dark:text-blue-400 font-bold text-right tabular-nums whitespace-nowrap">à§³ {{ total_bank_transfer|floatformat:2 }}</td>
          <td class="px-4 py-2 border text-blue-700 dark:text-blue-400 font-bold text-right tabular-nums whitespace-nowrap">à§³ {{ total_cash_amount|floatformat:2 }}</td>
          <td colspan="7" class="border"></td>
          <td class="px-4 py-2 border text-right">Difference:</td>
          <td class="px-4 py-2 border 
            {% if total_salary_difference > 0 %} text-green-700 dark:text-green-400
            {% elif total_salary_difference < 0 %} text-red-600 dark:text-red-400
            {% else %} text-gray-700 dark:text-gray-300 {% endif %} tabular-nums whitespace-nowrap">
            à§³ {{ total_salary_difference|floatformat:2 }}
            {% if total_salary_difference > 0 %}
              <span class="ml-2 text-green-600 dark:text-green-400 font-normal text-xs">(Extra Salary Paid)</span>
            {% elif total_salary_difference < 0 %}
              <span class="ml-2 text-red-600 dark:text-red-400 font-normal text-xs">(Company Balance)</span>
            {% else %}
              <span class="ml-2 text-gray-600 dark:text-gray-400 font-normal text-xs">(No Difference)</span>
            {% endif %}
          </td>
          <td class="px-4 py-2 border text-right">Final Salary Total:</td>
          <td class="px-4 py-2 border text-green-700 dark:text-green-400 font-bold text-right tabular-nums whitespace-nowrap">à§³ {{ total_final_salary|floatformat:2 }}</td>
          <td class="px-4 py-2 border text-red-700 dark:text-red-400 font-bold text-right tabular-nums whitespace-nowrap">à§³ {{ total_payable_cash|floatformat:2 }}</td>
        </tr>
      </tfoot>
    </table>
  </div>
{% else %}
  <p class="text-center text-gray-500 dark:text-gray-300 mt-8 font-semibold text-lg">No data found for the selected month.</p>
{% endif %}
{% endblock %}
