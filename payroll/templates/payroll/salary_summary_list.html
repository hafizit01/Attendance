{% extends 'base.html' %}

{% block content %}
<h2 class="text-2xl md:text-3xl font-semibold mb-4 text-gray-800 dark:text-gray-100 text-center">
  ðŸ§¾ Salary Summary List
</h2>

<div class="mt-4 text-right">
  {% if summaries %}
    <a href="{% url 'payroll:salary_summary_pdf' %}?month={{ selected_month }}&department={{ selected_department_id }}&employee={{ selected_employee_id }}"
       class="inline-flex items-center bg-green-600 text-white px-4 py-2 rounded-md shadow hover:bg-green-700 transition duration-150"
       target="_blank">
       ðŸ“„ Export PDF
    </a>
  {% else %}
    <button class="inline-flex items-center bg-gray-300 text-gray-600 px-4 py-2 rounded-md shadow cursor-not-allowed" disabled>
       ðŸ“„ Export PDF (No Data)
    </button>
  {% endif %}
</div>

<!-- Filters -->
<form method="get" class="bg-white dark:bg-gray-900 dark:text-gray-200 p-6 rounded-lg shadow-md mb-6">
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

    <!-- Month Selector -->
    <div>
      <label for="month" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Month:</label>
      <input type="month" id="month" name="month" value="{{ selected_month }}"
             class="w-full border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 px-3 py-2">
    </div>

    <!-- Department Selector -->
    <div>
      <label for="department" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Department:</label>
      <select id="department" name="department"
              class="w-full border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 px-3 py-2">
        <option value="">All Departments</option>
        {% for dept in departments %}
          <option value="{{ dept.id }}" {% if dept.id|stringformat:"s" == selected_department %}selected{% endif %}>
            {{ dept.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Employee Selector -->
    <div>
      <label for="employee" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Employee:</label>
      <select id="employee" name="employee"
              class="w-full border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 px-3 py-2">
        <option value="">All Employees</option>
        {% for emp in employees %}
          <option value="{{ emp.id }}" {% if emp.id|stringformat:"s" == selected_employee %}selected{% endif %}>
            {{ emp.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Submit Button -->
    <div class="flex items-end">
      <button type="submit"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-md transition shadow">
        ðŸ“Š Show Report
      </button>
    </div>

  </div>
</form>

{% load custom_filters %}


{% if summaries %}
<div class="overflow-x-auto rounded-lg border border-gray-300 dark:border-gray-700">
  <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
    <thead class="bg-gray-100 dark:bg-gray-800 sticky top-0 z-10">
      <tr>
        <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">#</th>
        <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Employee</th>
        <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Month</th>
        <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Base Salary</th>
        <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Bank Transfer</th>
        <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Cash Amount</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Present</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Leave</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Absent</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Weekly Off</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Public Holidays</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Late Time</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Over Time</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Total Work</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Expected Work</th>
        <th class="px-4 py-2 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Diff</th>
        <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Earned Salary</th>
        <th class="px-4 py-2 text-right text-xs font-medium text-gray-600 dark:text-gray-300 uppercase border">Bonus</th>
        <th class="px-4 py-2 text-right text-xs font-medium text-green-600 uppercase border">Final Salary</th>
        <th class="px-4 py-2 text-right text-xs font-medium text-red-600 uppercase border">Payable Cash</th>
      </tr>
    </thead>

    <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
      {% for s in summaries %}
      <tr class="odd:bg-white even:bg-gray-50 dark:odd:bg-gray-900 dark:even:bg-gray-800 hover:bg-blue-50 dark:hover:bg-gray-700 transition">
        <td class="px-4 py-2 border">{{ forloop.counter }}</td>
        <td class="px-4 py-2 border">{{ s.employee.name }}</td>
        <td class="px-4 py-2 border">{{ s.month }}</td>
        <td class="px-4 py-2 border text-right">à§³ {{ s.base_salary|floatformat:2 }}</td>
        <td class="px-4 py-2 border text-right">à§³ {{ s.bank_transfer|floatformat:2 }}</td>
        <td class="px-4 py-2 border text-right">à§³ {{ s.cash_amount|floatformat:2 }}</td>
        <td class="px-4 py-2 border text-center">{{ s.present_days }}</td>
        <td class="px-4 py-2 border text-center">{{ s.leave_days }}</td>
        <td class="px-4 py-2 border text-center">{{ s.absent_days }}</td>
        <td class="px-4 py-2 border text-center">{{ s.weekly_off_days }}</td>
        <td class="px-4 py-2 border text-center">{{ s.holiday_days }}</td>
        <td class="px-4 py-2 border text-center">{{ s.late_time }}</td>
        <td class="px-4 py-2 border text-center">{{ s.over_time|format_timedelta }}</td>
        <td class="px-4 py-2 border text-center">{{ s.total_work_hours }}</td>
        <td class="px-4 py-2 border text-center">{{ s.expected_work_hours }}</td>
        <td class="px-4 py-2 border text-center">{{ s.work_time_difference }}</td>
        <td class="px-4 py-2 border text-right">à§³ {{ s.earned_salary|floatformat:2 }}</td>
        <td class="px-4 py-2 border text-right">
          {% if s.bonus_amount and s.bonus_amount|floatformat:2 != "0.00" %}
            <span class="inline-flex items-center rounded-full bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 text-xs font-medium px-2 py-0.5">
              à§³ {{ s.bonus_amount|floatformat:2 }}
            </span>
          {% else %}
            à§³ 0.00
          {% endif %}
        </td>
        <td class="px-4 py-2 border font-semibold text-green-700 dark:text-green-400 text-right">à§³ {{ s.final_salary|floatformat:2 }}</td>
        <td class="px-4 py-2 border font-semibold text-red-700 dark:text-red-400 text-right">à§³ {{ s.payable_cash|floatformat:2 }}</td>
      </tr>
      {% endfor %}
    </tbody>

    <!-- Footer -->
    <tfoot class="bg-gray-100 dark:bg-gray-800 font-semibold">
      <tr>
        <td colspan="3" class="px-4 py-2 border text-right">Basic Salary Total:</td>
        <td class="px-4 py-2 border text-blue-700 dark:text-blue-400 font-bold text-right">à§³ {{ total_base_salary|floatformat:2 }}</td>
        <td class="px-4 py-2 border text-blue-700 dark:text-blue-400 font-bold text-right">à§³ {{ total_bank_transfer|floatformat:2 }}</td>
        <td class="px-4 py-2 border text-blue-700 dark:text-blue-400 font-bold text-right">à§³ {{ total_cash_amount|floatformat:2 }}</td>
        <td colspan="7" class="border"></td>
        <td class="px-4 py-2 border text-right">Difference:</td>
        <td class="px-4 py-2 border 
          {% if total_salary_difference > 0 %} text-green-700 dark:text-green-400
          {% elif total_salary_difference < 0 %} text-red-600 dark:text-red-400
          {% else %} text-gray-700 dark:text-gray-300 {% endif %}">
          à§³ {{ total_salary_difference|floatformat:2 }}
          {% if total_salary_difference > 0 %}
            <span class="ml-2 text-green-600 dark:text-green-400 font-normal text-xs">(Extra Salary Paid)</span>
          {% elif total_salary_difference < 0 %}
            <span class="ml-2 text-red-600 dark:text-red-400 font-normal text-xs">(Company Balance)</span>
          {% else %}
            <span class="ml-2 text-gray-600 dark:text-gray-400 font-normal text-xs">(No Difference)</span>
          {% endif %}
        </td>
        <td colspan="1" class="px-4 py-2 border text-right">Final Salary Total:</td>
        <td class="px-4 py-2 border text-green-700 dark:text-green-400 font-bold text-right">à§³ {{ total_final_salary|floatformat:2 }}</td>
        <td class="px-4 py-2 border text-red-700 dark:text-red-400 font-bold text-right">à§³ {{ total_payable_cash|floatformat:2 }}</td>
      </tr>
    </tfoot>
  </table>
</div>
{% else %}
  <p class="text-center text-gray-500 dark:text-gray-300 mt-8 font-semibold text-lg">No data found for the selected month.</p>
{% endif %}
{% endblock %}
