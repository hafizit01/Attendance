{% extends 'base.html' %}
{% block title %}Salary Summary{% endblock %}
{% block content %}
{% load custom_filters %}

<div class="w-full px-2 sm:px-4 py-6 space-y-6 animate-in fade-in duration-500">

  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
            <span class="p-2 bg-emerald-100 dark:bg-emerald-900 rounded-lg text-emerald-600">üßæ</span>
            Salary Summary
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Monthly payroll breakdown and financial summary.</p>
    </div>

    {% if summaries %}
    <a href="{% url 'payroll:salary_summary_pdf' %}?month={{ selected_month }}&department={{ selected_department_id }}&employee={{ selected_employee_id }}"
       target="_blank"
       class="inline-flex items-center gap-2 px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl shadow-lg shadow-emerald-200 dark:shadow-none transition-all hover:-translate-y-0.5 active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
        Export PDF
    </a>
    {% endif %}
  </div>

  {% if summaries %}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow border-l-4 border-blue-500 dark:border-blue-400">
          <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Total Base Salary</div>
          <div class="text-2xl font-bold text-blue-600 dark:text-blue-400 tabular-nums">
              ‡ß≥ {{ total_base_salary|floatformat:2 }}
          </div>
      </div>

      <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow border-l-4 border-indigo-500 dark:border-indigo-400">
          <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Total Final Salary</div>
          <div class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 tabular-nums">
              ‡ß≥ {{ total_final_salary|floatformat:2 }}
          </div>
      </div>

      <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow border-l-4 border-rose-500 dark:border-rose-400">
          <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Total Payable Cash</div>
          <div class="text-2xl font-bold text-rose-600 dark:text-rose-400 tabular-nums">
              ‡ß≥ {{ total_payable_cash|floatformat:2 }}
          </div>
      </div>

      <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow border-l-4 
                  {% if total_salary_difference < 0 %} border-orange-500 {% else %} border-green-500 {% endif %}">
          <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Net Difference</div>
          <div class="text-2xl font-bold tabular-nums
                      {% if total_salary_difference < 0 %} text-orange-600 {% else %} text-green-600 {% endif %}">
              ‡ß≥ {{ total_salary_difference|floatformat:2 }}
          </div>
      </div>
  </div>
  {% endif %}

  <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
    <form method="get" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 items-end">
        <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Select Month</label>
            <input type="month" name="month" value="{{ selected_month }}"
                   class="w-full bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-200 text-sm px-3 py-2.5 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
        </div>

        <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Department</label>
            <select name="department"
                    class="w-full bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-200 text-sm px-3 py-2.5 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none appearance-none transition-all">
                <option value="">All Departments</option>
                {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if dept.id|stringformat:"s" == selected_department_id %}selected{% endif %}>{{ dept.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1.5">Employee</label>
            <select name="employee"
                    class="w-full bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-200 text-sm px-3 py-2.5 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none appearance-none transition-all">
                <option value="">All Employees</option>
                {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if emp.id|stringformat:"s" == selected_employee_id %}selected{% endif %}>{{ emp.name }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold text-sm px-4 py-2.5 rounded-xl shadow-md transition-all">
            Show Report
        </button>
    </form>
  </div>

  {% if summaries %}
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 overflow-hidden relative">
    <div class="overflow-x-auto min-h-[500px] pb-2">
      <table class="w-full text-xs text-left border-collapse whitespace-nowrap">
        <thead class="bg-gray-50 dark:bg-gray-700/50 text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wider sticky top-0 z-10 shadow-sm">
          <tr>
            <th class="px-4 py-4 w-12 text-center sticky left-0 z-20 bg-gray-50 dark:bg-gray-800">#</th>
            <th class="px-4 py-4 min-w-[180px] sticky left-12 z-20 bg-gray-50 dark:bg-gray-800 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.1)]">Employee</th>
            <th class="px-4 py-4">Month</th>
            
            <th class="px-4 py-4 text-right bg-blue-50/50 dark:bg-blue-900/10 text-blue-600">Base Salary</th>
            <th class="px-4 py-4 text-right bg-blue-50/50 dark:bg-blue-900/10 text-blue-600">Bank Trans.</th>
            <th class="px-4 py-4 text-right bg-blue-50/50 dark:bg-blue-900/10 text-blue-600">Cash Amt</th>

            <th class="px-3 py-4 text-center">‚úÖ Pres</th>
            <th class="px-3 py-4 text-center">üìÖ Leave</th>
            <th class="px-3 py-4 text-center">‚ùå Abs</th>
            <th class="px-3 py-4 text-center">üõå Off</th>
            <th class="px-3 py-4 text-center">üèñ Hol</th>
            <th class="px-3 py-4 text-center text-amber-600">üïí Late</th>
            <th class="px-3 py-4 text-center text-purple-600">Over</th>
            <th class="px-4 py-4 text-center font-bold">Total Work</th>
            <th class="px-4 py-4 text-center">Expected</th>
            <th class="px-4 py-4 text-center">Diff</th>

            <th class="px-4 py-4 text-right text-indigo-600">Earned</th>
            <th class="px-4 py-4 text-right text-indigo-600">Bonus</th>
            <th class="px-4 py-4 text-right text-emerald-600 font-extrabold bg-emerald-50/50 dark:bg-emerald-900/10">Final Salary</th>
            <th class="px-4 py-4 text-right text-rose-600 font-extrabold bg-rose-50/50 dark:bg-rose-900/10">Payable Cash</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
          {% for s in summaries %}
          <tr class="group hover:bg-gray-50/80 dark:hover:bg-gray-900/40 transition-colors">
            <td class="px-4 py-4 text-center text-gray-400 font-mono sticky left-0 z-10 bg-white dark:bg-gray-800 group-hover:bg-gray-50 dark:group-hover:bg-gray-900">{{ forloop.counter }}</td>
            <td class="px-4 py-4 font-bold text-gray-800 dark:text-gray-100 sticky left-12 z-10 bg-white dark:bg-gray-800 group-hover:bg-gray-50 dark:group-hover:bg-gray-900 shadow-[4px_0_12px_-4px_rgba(0,0,0,0.05)]">
                {{ s.employee.name }}
            </td>
            <td class="px-4 py-4 font-mono text-gray-500">{{ s.month }}</td>

            <td class="px-4 py-4 text-right font-mono text-gray-600 dark:text-gray-300 bg-blue-50/10">‡ß≥ {{ s.base_salary|floatformat:2 }}</td>
            <td class="px-4 py-4 text-right font-mono text-gray-600 dark:text-gray-300 bg-blue-50/10">‡ß≥ {{ s.bank_transfer|floatformat:2 }}</td>
            <td class="px-4 py-4 text-right font-mono text-gray-600 dark:text-gray-300 bg-blue-50/10">‡ß≥ {{ s.cash_amount|floatformat:2 }}</td>

            <td class="px-3 py-4 text-center font-bold text-emerald-600">{{ s.present_days }}</td>
            <td class="px-3 py-4 text-center text-blue-500">{{ s.leave_days }}</td>
            <td class="px-3 py-4 text-center font-bold text-rose-500">{{ s.absent_days }}</td>
            <td class="px-3 py-4 text-center text-gray-400">{{ s.weekly_off_days }}</td>
            <td class="px-3 py-4 text-center text-gray-400">{{ s.holiday_days }}</td>
            <td class="px-3 py-4 text-center font-mono text-amber-600">{{ s.late_time }}</td>
            <td class="px-3 py-4 text-center font-mono text-purple-600">{{ s.over_time|format_timedelta }}</td>
            <td class="px-4 py-4 text-center font-mono font-bold text-blue-600">{{ s.total_work_hours }}</td>
            <td class="px-4 py-4 text-center font-mono text-gray-400">{{ s.expected_work_hours }}</td>
            <td class="px-4 py-4 text-center font-mono text-gray-500">{{ s.work_time_difference }}</td>

            <td class="px-4 py-4 text-right font-mono font-semibold text-indigo-600">‡ß≥ {{ s.earned_salary|floatformat:2 }}</td>
            <td class="px-4 py-4 text-right font-mono">
                {% if s.bonus_amount and s.bonus_amount|floatformat:2 != "0.00" %}
                    <span class="bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-2 py-0.5 rounded font-bold">
                        ‡ß≥ {{ s.bonus_amount|floatformat:2 }}
                    </span>
                {% else %}
                    <span class="text-gray-300">-</span>
                {% endif %}
            </td>
            <td class="px-4 py-4 text-right font-mono font-bold text-emerald-600 bg-emerald-50/30 dark:bg-emerald-900/10">‡ß≥ {{ s.final_salary|floatformat:2 }}</td>
            <td class="px-4 py-4 text-right font-mono font-bold text-rose-600 bg-rose-50/30 dark:bg-rose-900/10">‡ß≥ {{ s.payable_cash|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
        
        <tfoot class="bg-gray-100 dark:bg-gray-800 text-xs border-t-2 border-gray-300 dark:border-gray-600 font-bold sticky bottom-0 z-20 shadow-[0_-4px_12px_-4px_rgba(0,0,0,0.1)]">
            <tr>
                <td colspan="3" class="px-4 py-4 text-right text-gray-900 dark:text-white uppercase tracking-wider sticky left-0 bg-gray-100 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
                    Grand Total:
                </td>

                <td class="px-4 py-4 text-right font-mono text-blue-700 dark:text-blue-400 bg-blue-50/20">
                    ‡ß≥ {{ total_base_salary|floatformat:2 }}
                </td>

                <td class="px-4 py-4 text-right font-mono text-blue-700 dark:text-blue-400 bg-blue-50/20">
                    ‡ß≥ {{ total_bank_transfer|floatformat:2 }}
                </td>

                <td class="px-4 py-4 text-right font-mono text-blue-700 dark:text-blue-400 bg-blue-50/20">
                    ‡ß≥ {{ total_cash_amount|floatformat:2 }}
                </td>
                
                <td colspan="10" class="px-4 py-4 text-center text-gray-400 italic font-normal bg-gray-50 dark:bg-gray-800/50">
                    --
                </td>

                <td class="px-4 py-4 text-center text-gray-400">-</td> 
                <td class="px-4 py-4 text-center text-gray-400">-</td>

                <td class="px-4 py-4 text-right font-mono text-white bg-emerald-600">
                    ‡ß≥ {{ total_final_salary|floatformat:2 }}
                </td>

                <td class="px-4 py-4 text-right font-mono text-white bg-rose-600">
                    ‡ß≥ {{ total_payable_cash|floatformat:2 }}
                </td>
            </tr>
        </tfoot>
      </table>
    </div>
  </div>
  {% else %}
  <div class="flex flex-col items-center justify-center py-20 bg-white dark:bg-gray-800 rounded-2xl shadow border border-gray-100 dark:border-gray-700">
      <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-full mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
      </div>
      <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">No Salary Records Found</h3>
      <p class="text-sm text-gray-500">Please select a different month or check employee data.</p>
  </div>
  {% endif %}

</div>

<style>
    /* Sticky Column Shadow Logic */
    thead th:nth-child(2), tbody td:nth-child(2) {
        box-shadow: 4px 0 8px -4px rgba(0,0,0,0.05);
        clip-path: inset(0px -10px 0px 0px);
    }
</style>

{% endblock content %}